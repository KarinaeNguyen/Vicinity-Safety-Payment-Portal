<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="dist/main.css" rel="stylesheet"> 
    <title data-translate="title">QR Payment Gate | VICINITY SAFETY</title>
    
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Ldm0AssAAAAAMIE9rP6GwaCTGvgA2RYBWOBBE7aW" defer></script>
    
    <style>
        .g-blue { background-color: #4285F4; }
        .g-text-blue { color: #4285F4; }
        .flag-button {
            font-size: 1.5rem; line-height: 1; padding: 0 4px;
            cursor: pointer; opacity: 0.6; transition: opacity 0.2s;
            border: none; background: none;
        }
        .flag-button:hover, .flag-button.active { opacity: 1; }
    </style>
    
    <script>
        // --- Centralized Data ---
        const ACCOUNT_NO = '318851299';
        const RECAPTCHA_SITE_KEY = '6Ldm0AssAAAAAMIE9rP6GwaCTGvgA2RYBWOBBE7aW';
        // ... (translations data remains) ...
        
        let currentLang = 'en';

        function changeLanguage(lang) {
            currentLang = lang;
            document.title = translations[lang].title;
            localStorage.setItem('paymentLang', lang);

            // Update active state of flag buttons
            document.querySelectorAll('.flag-button').forEach(btn => {
                btn.classList.toggle('active', btn.id === `flag-${lang}`);
            });

            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                const text = translations[lang][key];
                
                if (element.placeholder !== undefined) {
                    element.placeholder = text; // Handles inputs
                } else {
                    element.textContent = text; // Handles buttons, labels, paragraphs, etc.
                }
            });
        }
        
        // ... (formatPhoneNumber function remains) ...

        // ASYNCHRONOUS FORM SUBMISSION using reCAPTCHA Enterprise
        async function handleSubmit(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value.replace(/\s/g, ''); // Clean phone number
            const submitButton = document.getElementById('submit-btn');

            if (!name || !phone) {
                showValidationError(translations[currentLang].name_phone_required);
                return;
            }
            
            // Toggle UI state
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="transparent" stroke-dasharray="80" stroke-linecap="round" stroke-dashoffset="60" style="stroke: white;"></circle></svg> ${translations[currentLang].submitting_btn}`;

            grecaptcha.enterprise.ready(async () => {
                try {
                    const token = await grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, {action: 'submit_payment_details'});
                    
                    // --- CRITICAL SECURITY: SEND DATA TO A SERVER ENDPOINT ---
                    // The client is not secure! This must hit your backend for verification.
                    const response = await fetch('/api/submit-payment-details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, phone, token }) // Send token to server
                    });
                    
                    if (response.ok) {
                        const formContainer = document.getElementById('details-form');
                        const confirmationBox = document.getElementById('confirmation-box');
                        const confirmationText = document.getElementById('confirmation-text');

                        // Update the confirmation message dynamically (cleaner structure)
                        confirmationText.innerHTML = `
                            <div class="space-y-3">
                                <p class="font-semibold text-lg text-green-600" style="color: #16a34a;">${translations[currentLang].confirmation_success}</p>
                                <p class="text-gray-700">${translations[currentLang].confirmation_message}</p>
                                <hr class="border-gray-200">
                                <p class="text-sm">
                                    <span class="font-medium text-gray-900">${translations[currentLang].conf_name}</span> ${name}<br>
                                    <span class="font-medium text-gray-900">${translations[currentLang].conf_phone}</span> ${phone}
                                </p>
                                <p class="text-xs text-gray-500 mt-2">
                                    ${translations[currentLang].conf_note}
                                </p>
                            </div>
                        `;

                        formContainer.classList.add('hidden');
                        confirmationBox.classList.remove('hidden');
                    } else {
                         // Server validation failed (e.g., failed reCAPTCHA score check on server)
                        throw new Error('Server submission failed');
                    }
                    // --- END CRITICAL SECTION ---
                    
                } catch (error) {
                    console.error("Submission error:", error);
                    submitButton.disabled = false;
                    submitButton.textContent = translations[currentLang].submit_btn;
                    submitButton.innerHTML = translations[currentLang].submit_btn; // Reset button text/spinner
                    showValidationError(translations[currentLang].security_failed);
                }
            });
        }
        
        // ... (other functions: showValidationError, copyText, and DOMContentLoaded remain) ...

        // Initialize language
        document.addEventListener('DOMContentLoaded', () => {
            const storedLang = localStorage.getItem('paymentLang') || 'en';
            changeLanguage(storedLang);
        });

    </script>
</head>

<body>
    <div class="text-gray-500 text-sm">
        <span class="font-medium text-green-600 mr-2" data-translate="secure_payment">SECURE PAYMENT</span>
        <span data-translate="account_no">Account No:</span> <span id="account-number-display">318851299</span>
        <button id="copy-btn" onclick="copyText(ACCOUNT_NO, 'copy-btn')" 
                class="ml-2 text-xs text-blue-500 hover:text-blue-700 transition duration-150" data-translate="copy_no">
            Copy No.
        </button>
    </div>
    
    </body>
</html>
